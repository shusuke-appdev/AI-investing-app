# SBI証券連携機能: 今後の作業ガイド（非エンジニア向け）

専門的な用語をできるだけ使わず、現在の状況と「残りの作業」について解説します。

## 1. 今、何が出来ているのか？

現在の状況を例えるなら、**「全自動データ収集ロボット（の体）」は完成したが、「目と手」の動きを教えていない状態** です。

- **体（プログラム）**: 毎日決まった時間に動き出し、データをクラウドへ送る仕組みは完成しました。
- **目と手（画面操作）**: 「画面のどこをクリックすれば『保有証券』が見れるか」「画面のどの数字が『現在の株価』なのか」を、まだ知りません。

そのため、現在は仮のデータ（トヨタ自動車などのダミー情報）をクラウドへ送信しています。

## 2. 取得できているデータ / できていないデータ

### Q. 株式指数（日経平均など）やオプションは取得できている？
**A. まだ取得できていません（ダミーデータです）。**

- **日本株・指数**:
    - HYPER SBI 2 の画面上に表示されている数字であれば、ロボットに「あそこを読んで」と教えることで取得可能です。
    - ただし、現在はその教える作業が完了していないため、実際の数字は取れていません。

- **米国株オプション**:
    - **このツール（SBI連携）の管轄外** です。
    - 米国株オプションのデータは、別途アプリ本体が海外のデータソース（FinnhubやYahoo Finance）から直接取得する仕組みになっていますので、**今回の作業とは関係なく動作します。**

## 3. これから必要な作業（詳細ステップ）

ここからの作業は、**「ロボットに画面の見方を教える（＝コードを書き換える）」**  作業になります。
少し難しく感じるかもしれませんが、パズルを埋めるような感覚で進めていきましょう。

### Step 1: ツール（Inspect.exe）の準備
Windowsには、画面上のボタンや文字の「ID（識別番号）」を調べるための無料ツールがあります。
これを使って、「保有証券タブ」のIDを調べます。

1.  **Windows SDK** をインストール（または `Accessibility Insights` というアプリをMicrosoft Storeから入手）。
2.  ツールを起動し、マウスポインタを HYPER SBI 2 の「保有証券」タブに合わせてみてください。
3.  ツール上に `AutomationId: "TabItem_Portfolio"` や `Name: "保有証券"` のような情報が表示されます。これをメモします。

### Step 2: コードの書き換え (`sbi_client.py`)

`tools/sbi_sync/sbi_client.py` というファイルをメモ帳やVS Codeで開きます。
`get_portfolio` という場所を探し、以下のように書き換えます。

**変更前（現在のダミー）:**
```python
# 何もせずダミーデータを返す
return [PortfolioItem(ticker="7203", ...)]
```

**変更後（イメージ）:**
```python
# 1. 「保有証券」タブをクリック（Step 1で調べた名前を使う）
self.main_window.child_window(title="保有証券", control_type="TabItem").click_input()

# 2. 全選択してコピー（Ctrl+A, Ctrl+C）
self.main_window.type_keys("^a^c")

# 3. クリップボードの中身（コピーしたテキスト）を取得
text_data = pyperclip.paste()

# 4. テキストを分解してデータにする（ここが少しプログラミングパズルです）
# 例: "7203 トヨタ 100株 ..." という文字を分解する
```

### 難易度が高いと感じたら？

もし Step 2 の「テキスト分解」が難しければ、**もっと簡単な方法（半自動）** もあります。

1.  **手動でコピー作戦**:
    - ユーザー様が自分で HYPER SBI 2 の画面で「保有証券」を表示し、全選択コピー（Ctrl+A, Ctrl+C）をしておきます。
    - プログラムは「クリップボードの中身を読み取ってクラウドへ送る」機能だけに専念させます。
    - これなら、「クリックする場所を教える」作業を省略できます。

## まとめ

- **今の状態**: ロボットは動いていますが、目は見えておらず、適当な（ダミーの）メモをクラウドへ送っています。
- **必要なこと**: ロボットに「画面のここを見て！」と教える（コードの微修正）。
- **目的**: ダミーではなく、実際のHYPER SBI 2の画面に表示されている数字を送れるようにする。

まずは、`sbi_client.py` を開き、**「あ、ここを直せばいいんだな」** という場所（`get_portfolio` メソッド）を確認することから始めてみてください。
